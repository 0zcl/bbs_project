{% extends "base.html" %}


{% block page_container %}

    <div class="chat-container">
        <div class="left-chat-panel">
            left
            <div>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#friends" role="tab" data-toggle="tab">好友</a></li>
                    <li role="presentation"><a href="#group" role="tab" data-toggle="tab">群组</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">

                    <div role="tabpanel" class="tab-pane active" id="friends">
                        <ul class="list-group">
                            {% for friend in request.user.userprofile.friends.select_related %}
                                <li contact-type="single" id="{{ friend.id }}" class="list-group-item"
                                    onclick="OpenChatWindow(this)">
                                    <span class="badge hide">0</span>
                                    <span class="contact-name">{{ friend.name }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="group">
                        <ul class="list-group">
                            {% for group in request.user.userprofile.group_members.select_related %}
                                <li contact-type="group" id="{{ group.id }}" class="list-group-item"
                                    onclick="OpenChatWindow(this)">
                                    <span class="badge hide">0</span>
                                    <span class="contact-name">{{ group.name }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

            </div>

        </div>

        <div class="right-chat-panel">

            <div class="chat-box-title" contact-id="" contact-type="">title</div>

            <div class="chat-box-window">window</div>
            <div class="chat-box-emoj">
                <span class="glyphicon glyphicon-download-alt" style="float:right;right: 50%;" onclick="FileUpload()"></span>
                <input id="file_upload" type="file" />
            </div>
            <div class="chat-box-msg">
                <textarea id="msg"></textarea>
                <button class="btn btn-success">发送</button>
            </div>
        </div>
        <div class="clear-both"></div>
    </div>


{% endblock %}


{% block bottom-js %}
    <script>
        // using js to get csrftoken
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        console.log(csrftoken);
        // end js

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        // 全局字典，用于存切换视图前的html元素
        GLOBAL_CHAT_RECORD_DIC = {
            "single":{},
            "group":{}
        };

        $(document).ready(function () {
            // 在发送ajax之前设置csrf(set csrf before send ajax)
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });  // end set csrf

            // 让聊天室版块高亮
            //$(".navbar-nav a[href='{{ request.path }}']").parent().addClass("active");
            // 事件委托
            $("body").delegate("textarea", "keydown", function (e) {  // e==event
                if(e.which == 13){  // 按下键的数字(e.which);13是enter键的ASCII码
                    var msg_text = $("textarea").val();
                    if ($.trim(msg_text).length > 0){
                        console.log(msg_text);
                        // 发送消息给对方
                        SendMsg(msg_text);
                        // 将发送的信息打印到自己的window界面
                        AddSendMsgIntoWindow(msg_text);
                        $("textarea").val("");  // 将输入框清空
                    }else {
                        alert("请输入要发送的消息")
                    }

                }
            });
{#            用定时器浏览器会崩(卡)#}
{#            setInterval(function () {#}
{#                GetNewMsgs();#}
{#            }, 3000)#}
            GetNewMsgs();  // 开始取消息
        });

        // 点击左侧界面的好友，触发事件，打开聊天界面
        function OpenChatWindow(ele) {
            // console.log($(ele));
            $(ele).addClass("active");  // 对左侧点击的好友增加高亮
            $(ele).siblings().removeClass("active");  // 将同级元素去除高亮属性
            var contact_id = $(ele).attr("id");
            var contact_type = $(ele).attr("contact-type");
            var contact_name = $(ele).find(".contact-name").text();
            console.log(contact_id);
            console.log(contact_type);
            console.log(contact_name);
            // 视图切换，在切换之前将原本的视图的html元素存到全局字典
            // 原本的框题框contact-id属性不为空，即切换视图前左侧已有点击对象
            if ($(".chat-box-title").attr("contact-id")){
                // 从标题框取出切换前用户的id,与联系方式contact-type
                var session_id = $(".chat-box-title").attr("contact-id");
                var session_type = $(".chat-box-title").attr("contact-type");
                // 将切换产前的视图存入全局字典
                GLOBAL_CHAT_RECORD_DIC[session_type][session_id] = $(".chat-box-window").html();
            }

            var chat_box_title_content = "<span>正在和 " + contact_name + " 聊天</span>";
            $(".chat-box-title").html(chat_box_title_content);
            // 给标题框添加 通信对象的id,通信类型(群发或单独发)
            $(".chat-box-title").attr("contact-id", contact_id);
            $(".chat-box-title").attr("contact-type", contact_type);

            // 若原本是有消息数量提醒，点击后无消息数量提醒
            $(ele).find(".badge").text(0);  // 将消息提醒量置为0
            $(ele).find(".badge").addClass("hide");  // 隐藏

            // 把chat-window的html元素从全局字典中存出来
            // 第一次点击该联系人时，chat_record为undefined,因为字典的single下还没有生成id(key)对应的value
            var chat_record = GLOBAL_CHAT_RECORD_DIC[contact_type][contact_id];
            console.log(chat_record,typeof chat_record);
            if (typeof chat_record == "undefined"){
                $(".chat-box-window").html("");
            }else {
                // 如果chat_record为undefined，则下面代码无法将对话界面清空(重要)
                $(".chat-box-window").html(chat_record);
                console.log("haha>>", chat_record)
            }

        }

        function AddSendMsgIntoWindow(msg_text) {
            var new_msg_ele = "<div class='msg-item'>" +
                                "<span>" + "{{ request.user.userprofile.name }}" + "</span>" +
                                "<span>" + new Date().toLocaleDateString() + "</span>" +
                                "<div class='msg-text'>" + msg_text + "</div>" +
                            "</div>";
            $(".chat-box-window").append(new_msg_ele);

            $(".chat-box-window").animate({
                scrollTop: $(".chat-box-window")[0].scrollHeight  // 每隔0.5s 自动向下滚动
            }, 500);
            // console.log($(".chat-box-window")[0]);
        }
        
        // 发送消息给好友或群组
        function SendMsg(msg_text) {
            var contact_id = $(".chat-box-title").attr("contact-id");
            var contact_type = $(".chat-box-title").attr("contact-type");
            if (contact_id && contact_type){
                var msg_item = {
                    "from": "{{ request.user.userprofile.id }}",
                    "to": contact_id,
                    "type": contact_type,
                    "msg": msg_text  // 要发送的消息
                };
                
                $.post("{% url 'send_msg' %}",
                    {"msg_dic": JSON.stringify(msg_item)},
                    function (callback) {
                        console.log(callback, typeof callback);
                    })
            }else {
                alert("请选择发送消息的对象")
            }
        }

        // 用户获取消息
        function GetNewMsgs() {
            console.log("----getting new msg----");
            $.getJSON("{% url 'get_new_msgs' %}",
                function (callback) {
                    // callback是列表对象，object, 列表每个元素都是一个消息字典
                    console.log(callback, typeof callback);  // Array [Object] object
                    // 解析消息，用户可能收到与当前正在聊天用户的消息，也可能是其他用户发的消息
                    ParseNewMsgs(callback);

                    return GetNewMsgs();  //　递归
                })
        }

        // 解析消息，用户可能收到与当前正在聊天用户的消息，也可能是其他用户发的消息
        function ParseNewMsgs(callback) {
            // callback为列表形式，列表的每个元素是数据字典形式(含时间戳)
            // 当前聊天窗口的contact-id,与聊天方式(群聊??)
            var current_session_id = $(".chat-box-title").attr("contact-id");
            var current_session_type = $(".chat-box-title").attr("contact-type");
            for (var msg_item in callback){
                // {'from': '3', 'timestamp': 1495542839.880795, 'msg': '\naaaassss', 'type': 'single', 'to': '1'}
                console.log(">>",callback[msg_item]);
                // console.log(">>>",callback[msg_item]["from"]);  // 这两种方式都可以
                // console.log(">>>",callback[msg_item].from);
                // 将数据字典渲染成html格式
                var new_msg_ele = "<div class='msg-item'>" +
                                        "<span style='color:red'>" + callback[msg_item]["from"] + "</span>" +
                                        "<span>" + callback[msg_item]["timestamp"]+ "</span>" +
                                        "<div class='msg-text'>" + callback[msg_item]["msg"] + "</div>" +
                                    "</div>";
                // 如果是一对一发信息，消息接收方根据发消息方的id，将消息添加到聊天窗口
                // 如果是群聊，消息接收方根据群的id，将消息添加到聊天窗口
                if (callback[msg_item]["type"]=="single"){
                    var msg_from_contact_id = callback[msg_item]["from"];
                }else {
                    var msg_from_contact_id = callback[msg_item]["to"];
                }
                // 用户收到的是与当前正在聊天用户的消息
                if (current_session_id==msg_from_contact_id && current_session_type==callback[msg_item]["type"]){
                    // 将消息的html元素添加到聊天窗口
                    $(".chat-box-window").append(new_msg_ele);
                }else {
                    // 用户没打开消息发送者的对话框，消息暂存到内存中(全局变量中)
                    if (typeof GLOBAL_CHAT_RECORD_DIC[callback[msg_item]["type"]][msg_from_contact_id]=="undefined"){
                        GLOBAL_CHAT_RECORD_DIC[callback[msg_item].type][msg_from_contact_id]=new_msg_ele;
                    }else {  // 如果GLOBAL_CHAT_RECORD_DIC[current_session_type][current_session_id]为undefined
                        GLOBAL_CHAT_RECORD_DIC[callback[msg_item].type][msg_from_contact_id]+=new_msg_ele;
                    }
                }
                // 新消息提醒, 下面这句代码花了我不少时间呢!
                var contact_ele = $(".list-group li[contact-type='"+callback[msg_item].type+"'][id='"+msg_from_contact_id+"']");
                console.log(">>>>:", contact_ele.text());
                var current_new_msg_count = $(contact_ele).find(".badge").text();
                console.log(">>current_new_msg_count", current_new_msg_count, typeof current_new_msg_count);
                $(contact_ele).find(".badge").removeClass("hide");
                $(contact_ele).find(".badge").text(parseInt(current_new_msg_count)+1);

            }


        }

        function FileUpload() {
            var formData = new FormData();
            console.log("formData:>>", formData);
            // console.log($("#file_upload")[0].files[0]);
            formData.append("file", $("#file_upload")[0].files[0]);
            $.ajax({
                url:"{% url 'webchat_file_upload' %}",  // 向后台发起请求的url
                type:"POST",  // 向后台发起POST请求
                data: formData,
                // * 必须false才会避开jQuery对 formdata 的默认处理;XMLHttpRequest会对 formdata 进行正确的处理
                processData:false,
                contentType:false,  // 必须false才会自动加上正确的Content-Type
                //当请求执行完成之后，自动调用，arg(参数):服务器返回的数据
                success: function (arg) {
                    console.log("arg>>:",arg);
                }

            }); // end ajax

        }
        
    </script>

{% endblock %}







